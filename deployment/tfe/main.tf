# Deploy Partner service on active and passive regions
module "ecs" {
  source                                         = "tfe.deploy.synkrato.io/Admin/ecs-infra/aws"
  version                                        = "4.3.2"
  active_aws_region                              = local.active_aws_region
  active_region_acm_certificate_arn              = ""
  active_region_alb_cidr_ingress_rule            = local.active_region_alb_cidr_ingress_rule
  active_region_alb_security_group_list          = local.active_region_alb_security_group_list
  active_region_alb_sg_egress_rule               = local.active_region_alb_sg_egress_rule
  active_region_container_environment_variables  = local.active_region_container_environment_variables
  active_region_cop_ec2_sg_id                    = data.aws_security_group.active-cop-ec2-security-group.id
  active_region_cop_ecs_cluster_name             = local.active_region_cop_ecs_cluster_name
  active_region_desired_count                    = var.active_region_desired_count
  active_region_max_count                        = var.active_region_max_count
  active_region_min_count                        = var.active_region_min_count
  active_region_vpc_name                         = local.vpc_name
  active_region_sns_topic_arn                    = data.aws_sns_topic.active-region-cloudwatch-alert-topic.arn
  request_count_autoscale_down_step_adjustment   = local.autoscale_down_step_adjustment
  request_count_autoscale_up_step_adjustment     = local.autoscale_up_step_adjustment
  certificate_domain_name                        = var.certificate_domain_name
  container_registry_url                         = var.container_registry_url
  cpu                                            = var.cpu
  deploy_to_passive_region                       = var.deploy_to_passive_region
  docker_image                                   = var.docker_image
  ecs_auto_scaling_task_role_principal_list      = local.ecs_auto_scaling_task_role_principal_list
  ecs_auto_scaling_task_role_policy_statement    = local.ecs_auto_scaling_task_role_policy_statement
  ecs_service_role                               = data.aws_iam_role.cop_service_role.arn
  ecs_task_role_principal_list                   = local.ecs_task_role_principal_list
  ecs_task_role_policy_statement                 = local.ecs_task_role_policy_statement
  enable_alb                                     = true
  enable_request_count_autoscaling               = true
  request_count_autoscale_down_alarm_threshold   = var.request_count_autoscale_down_alarm_threshold
  request_count_autoscale_up_alarm_threshold     = var.request_count_autoscale_up_alarm_threshold
  request_count_autoscale_down_alarm_statistic   = var.request_count_autoscale_down_alarm_statistic
  request_count_autoscale_up_alarm_statistic     = var.request_count_autoscale_up_alarm_statistic
  enable_ssl                                     = true
  environment                                    = var.environment
  health_check_path                              = "/health"
  health_check_interval                          = var.health_check_interval
  health_check_unhealthy_threshold               = var.health_check_unhealthy_threshold
  health_check_healthy_threshold                 = var.health_check_healthy_threshold
  health_check_timeout                           = var.health_check_timeout
  hosted_zone_name                               = var.hosted_zone_name
  hosted_zone_record_name                        = var.hosted_zone_record_name
  log_retention_days                             = var.log_retention_days
  log_group_name                                 = "epc2-${var.environment}-partner_service-epc2"
  is_private_hosted_zone                         = false
  passive_region_acm_certificate_arn             = ""
  passive_region_alb_cidr_ingress_rule           = local.passive_region_alb_cidr_ingress_rule
  passive_region_alb_security_group_list         = local.passive_region_alb_security_group_list
  passive_region_alb_sg_egress_rule              = local.passive_region_alb_sg_egress_rule
  passive_aws_region                             = local.passive_aws_region
  passive_region_container_environment_variables = local.passive_region_container_environment_variables
  passive_region_cop_ec2_sg_id                   = coalesce(join("", data.aws_security_group.passive-cop-ec2-security-group.*.id), " ")
  passive_region_cop_ecs_cluster_name            = local.passive_region_cop_ecs_cluster_name
  passive_region_desired_count                   = var.passive_region_desired_count
  passive_region_max_count                       = var.passive_region_max_count
  passive_region_min_count                       = var.passive_region_min_count
  passive_region_vpc_name                        = local.vpc_name
  passive_region_sns_topic_arn                   = data.aws_sns_topic.passive-region-cloudwatch-alert-topic.arn
  port                                           = local.port
  service_name                                   = "partner"
  soft_memory_limit                              = var.soft_memory_limit
  ssl_policy                                     = local.ssl_policy
  tags                                           = local.tags
}
